<app-layout>
  <div class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8 pt-20">
      <aside class="lg:w-80 bg-white rounded-2xl shadow-lg p-8 h-fit top-8" [class.hidden]="showBookingPage">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Filters</h2>
          <button (click)="clearFilters()" class="text-sm text-purple-600 hover:text-purple-800 font-medium">Clear All</button>
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-700 mb-4">Languages</label>
          <div class="flex flex-wrap gap-2">
            <button *ngFor="let lang of languages" 
                    (click)="applyFilter('language', lang.value)"
                    [class.bg-purple-100]="currentFilters.language === lang.value"
                    [class.text-purple-700]="currentFilters.language === lang.value"
                    [class.bg-gray-100]="currentFilters.language !== lang.value"
                    [class.text-gray-700]="currentFilters.language !== lang.value"
                    class="filter-chip px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200">
              {{ lang.label }}
            </button>
          </div>
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-700 mb-4">Genres</label>
          <div class="flex flex-wrap gap-2">
            <button *ngFor="let genre of genres" 
                    (click)="applyFilter('genre', genre.value)"
                    [class.bg-purple-100]="currentFilters.genre === genre.value"
                    [class.text-purple-700]="currentFilters.genre === genre.value"
                    [class.bg-gray-100]="currentFilters.genre !== genre.value"
                    [class.text-gray-700]="currentFilters.genre !== genre.value"
                    class="filter-chip px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200">
              {{ genre.label }}
            </button>
          </div>
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-700 mb-4">Format</label>
          <div class="flex flex-wrap gap-2">
            <button *ngFor="let format of formats" 
                    (click)="applyFilter('format', format.value)"
                    [class.bg-purple-100]="currentFilters.format === format.value"
                    [class.text-purple-700]="currentFilters.format === format.value"
                    [class.bg-gray-100]="currentFilters.format !== format.value"
                    [class.text-gray-700]="currentFilters.format !== format.value"
                    class="filter-chip px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200">
              {{ format.label }}
            </button>
          </div>
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-700 mb-4">Rating</label>
          <div class="flex flex-wrap gap-2">
            <button *ngFor="let rating of ratings" 
                    (click)="applyFilter('rating', rating.value)"
                    [class.bg-purple-100]="currentFilters.rating === rating.value"
                    [class.text-purple-700]="currentFilters.rating === rating.value"
                    [class.bg-gray-100]="currentFilters.rating !== rating.value"
                    [class.text-gray-700]="currentFilters.rating !== rating.value"
                    class="filter-chip px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200">
              {{ rating.label }}
            </button>
          </div>
        </div>
      </aside>

      <main class="flex-1">
        <div *ngIf="!showBookingPage">
          <div class="flex items-center justify-between mb-8">
            <div>
              <h1 class="text-3xl font-bold text-gray-800 mb-2">Movies</h1>
              <p class="text-gray-600">Showing {{ filteredMovies.length }} movies</p>
            </div>
          </div>

          <div *ngIf="filteredMovies.length > 0; else noMovies" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div *ngFor="let movie of filteredMovies" 
                 class="movie-card bg-white shadow-lg rounded-lg overflow-hidden hover:shadow-xl transition-shadow duration-300">
              <div class="relative overflow-hidden">
                <img [src]="movie.poster" 
                     [alt]="movie.title" 
                     class="w-full h-80 object-cover">
                <div class="absolute bottom-4 left-4 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-xs">
                  {{ movie.rating }} | {{ movie.language }}
                </div>
              </div>
              <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2">{{ movie.title }}</h3>
                <p class="text-gray-600 text-sm mb-4">{{ movie.genre?.join(' • ') || 'No genres' }} • {{ movie.duration }}</p>
                <button (click)="openBookingPage(movie)" 
                        class="book-now-btn w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-3 rounded-lg font-medium hover:shadow-lg transition-all duration-300">
                  Book Now
                </button>
              </div>
            </div>
          </div>

          <ng-template #noMovies>
            <div class="col-span-full text-center py-12">
              <h3 class="text-xl font-medium text-gray-600">No movies found matching your filters</h3>
              <p class="text-gray-500 mt-2">Try adjusting your search criteria</p>
            </div>
          </ng-template>
        </div>

        <div *ngIf="showBookingPage" class="mx-auto max-w-4xl px-4">
          <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-6">
              <img [src]="selectedMovie?.poster" [alt]="selectedMovie?.title" class="w-40 h-56 object-cover rounded-lg shadow-md">

              <div class="flex-1">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                  <h1 class="text-2xl md:text-3xl font-bold text-gray-900">{{ selectedMovie?.title }}</h1>
                  <button (click)="viewMovieDetails()" class="bg-white border border-purple-600 text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-50 transition-colors whitespace-nowrap">
                    View details
                  </button>
                </div>
                
                <div class="flex flex-wrap items-center gap-4 mb-4">
                  <span class="bg-gray-100 px-3 py-1 rounded-full text-sm font-medium">{{ selectedMovie?.rating }}</span>
                  <span class="text-gray-700">{{ selectedMovie?.language }}</span>
                  <span class="text-gray-700">{{ selectedMovie?.genre?.join(' • ') || 'No genres' }}</span>
                  <span class="text-gray-700">{{ selectedMovie?.duration }}</span>
                </div>
                
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                  <h3 class="font-semibold text-gray-800 mb-2">Synopsis</h3>
                  <p class="text-gray-600 text-sm">{{ selectedMovie?.synopsis }}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-6 mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <h3 class="text-sm font-semibold text-gray-700 mb-2">Date</h3>
              <div class="flex gap-2 overflow-x-auto pb-2">
                <button *ngFor="let date of dateOptions; let i = index" 
                        (click)="selectDate(i)"
                        [class.bg-black]="selectedDateIndex === i"
                        [class.text-white]="selectedDateIndex === i"
                        [class.bg-gray-100]="selectedDateIndex !== i"
                        class="date-option flex-shrink-0 px-4 py-3 rounded-lg text-center transition-colors hover:bg-gray-200">
                  <div class="font-bold">{{ date.day }}</div>
                  <div class="text-xs">{{ date.weekday }}</div>
                </button>
              </div>
            </div>
            
            <div>
              <h3 class="text-sm font-semibold text-gray-700 mb-2">Language</h3>
              <select [(ngModel)]="bookingLanguageFilter" (change)="filterShowtimes()" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <option value="">All Languages</option>
                <option *ngFor="let lang of uniqueLanguages" [value]="lang">{{ lang }}</option>
              </select>
            </div>
            
            <div>
              <h3 class="text-sm font-semibold text-gray-700 mb-2">Format</h3>
              <select [(ngModel)]="bookingFormatFilter" (change)="filterShowtimes()" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <option value="">All Formats</option>
                <option value="2D">2D</option>
                <option value="3D">3D</option>
                <option value="IMAX">IMAX</option>
              </select>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
            <div class="flex flex-wrap items-center gap-6 text-sm">
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                <span class="text-gray-600">Available (80+ seats)</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                <span class="text-gray-600">Filling fast (20-80 seats)</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                <span class="text-gray-600">Almost full (&lt;20 seats)</span>
              </div>
            </div>
          </div>

          <div *ngIf="filteredShowtimes.length > 0; else noShowtimes" class="space-y-6">
            <div *ngFor="let cinema of filteredShowtimes" class="bg-white rounded-lg shadow-lg p-6">
              <div class="flex items-start gap-4 mb-4">
                <div class="w-10 h-10 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold mt-1">
                  {{ cinema.theatre.name.substring(0, 1) }}
                </div>
                <div>
                  <h3 class="font-bold text-lg">{{ cinema.theatre.name }}</h3>
                  <p class="text-gray-600 text-sm">{{ cinema.theatre.location }}</p>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a *ngFor="let showtime of cinema.showtimes" 
                   [routerLink]="['/seat-selection']"
                   [queryParams]="{
                     movieId: selectedMovie?._id,
                     showId: showtime._id,
                     date: dateOptions[selectedDateIndex].date
                   }"
                   class="showtime-btn block text-center p-4 border border-gray-200 rounded-lg hover:border-purple-400 cursor-pointer transition-colors">
                  <div class="font-bold text-lg">{{ datePipe.transform(showtime.show_datetime, 'shortTime') }}</div>
                  <div class="text-sm text-gray-600">{{ showtime.screenName }} • {{ showtime.format.toUpperCase() }}</div>
                  <div class="text-sm font-semibold">₹{{ showtime.normal_price }} onwards</div>
                  <!-- <div class="text-xs" 
                       [class.text-green-500]="showtime.available_seats && showtime.available_seats > 80"
                       [class.text-yellow-500]="showtime.available_seats && showtime.available_seats <= 80 && showtime.available_seats > 20"
                       [class.text-red-500]="showtime.available_seats && showtime.available_seats <= 20">
                    {{ showtime.available_seats }} seats available
                  </div> -->
                </a>
              </div>
            </div>
          </div>

          <ng-template #noShowtimes>
            <div class="bg-white rounded-lg shadow-sm p-6 text-center">
              <p class="text-gray-600">No showtimes match your filters</p>
            </div>
          </ng-template>
        </div>
      </main>
    </div>
  </div>
</app-layout>